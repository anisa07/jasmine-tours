---
// Import global styles
import "@/styles/global.css";
import "@/styles/animations.css";
import SiteData from "@/config/siteData.json";
// If you already have config files, import them here:
import { defaultLocale, type Locale } from "@/i18n/config";
import { getPageTranslations } from "@/i18n/i18n";
import { Toaster } from "@/components/ui/sonner";
import { SEO, type SEOProps } from "astro-seo";

// Layout components
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import ThemeProvider from "@/components/ThemeProvider.astro";

// Props:
// - locale: current locale (can be string from URL params, will be validated)
// - pageNS: array of namespace names to load, e.g., ["home", "nav"]
// - title/description: SEO
// - alternates: map of locale -> URL for hreflang
const {
  locale: localeParam,
  pageNS = [], // e.g., ["home", "nav"]
  alternates = {} as Record<string, string>,
  seo,
} = Astro.props as {
  locale?: string | Locale;
  pageNS?: string[];
  alternates?: Record<string, string>;
  seo?: SEOProps;
};

// Validate locale - we assume valid locale since routing handles invalid ones
const activeLocale = (localeParam as Locale) || defaultLocale;

// Use the utility function to get translations (including navigation and common)
const { t, dir } = await getPageTranslations(activeLocale, [
  ...pageNS,
  "common",
  "nav",
]);

// Build absolute URL for canonical
const site = Astro.site?.origin ?? "https://example.com";
const url = new URL(Astro.url, site).href;
---

<html lang={activeLocale} dir={dir}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="google-site-verification"
      content="ibshIHUL36vOe2ldvh3WW7JT8DICzb23nSiFobq3pC8"
    />
    <!-- Dynamic Theme Color from CMS -->
    <ThemeProvider />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon-j.svg" />
    <link rel="icon" type="image/png" href="/assets/favicon-j.svg" />
    <link rel="apple-touch-icon" href="/assets/favicon-j.svg" />
    <link rel="shortcut icon" href="/favicon2.ico" />

    <!-- Canonical + hreflang -->
    <link rel="canonical" href={url} />
    {
      Object.entries(alternates).map(([lc, href]) => (
        <link rel="alternate" hreflang={lc} href={href} />
      ))
    }

    <link rel="alternate" hreflang="x-default" href={`${site}/`} />

    <!-- Sitemap and robots -->
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Add SEO component from astro-seo -->
    <SEO
      title={seo?.title || SiteData.default.title}
      description={seo?.description ?? SiteData.default.description}
      openGraph={seo?.openGraph ?? {
        basic: {
          image: SiteData.default.openGraph.image,
          title: SiteData.default.openGraph.title,
          type: SiteData.default.openGraph.type,
          url: SiteData.default.openGraph.url,
        },
        optional: {
          description: SiteData.default.openGraph.description,
          siteName: SiteData.default.openGraph.title,
        },
      }}
      twitter={seo?.twitter ?? {
        title: SiteData.default.twitter.title,
        description: SiteData.default.twitter.description,
        creator: SiteData.default.twitter.creator,
      }}
    />

    <!-- Schema.org Structured Data - LocalBusiness -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "TouristInformationCenter",
        "name": "Jasmine Tours",
        "description": "Premium tours and experiences in Amsterdam. Private tours, canal cruises, and authentic Dutch experiences with expert local guides.",
        "url": "https://jasmine-tours.nl",
        "logo": "https://jasmine-tours.nl/assets/favicon-j.svg",
        "image": "https://jasmine-tours.nl/images/og-image.jpg",
        "telephone": "+31642221525",
        "priceRange": "€€-€€€",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Amsterdam",
          "addressCountry": "NL"
        },
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": "52.3676",
          "longitude": "4.9041"
        },
        "openingHoursSpecification": {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
            "Sunday"
          ],
          "opens": "09:00",
          "closes": "21:00"
        },
        "sameAs": [
          "https://www.instagram.com/jasmine.tours.amsterdam",
          "https://www.facebook.com/jasmintoursevents/",
          "https://wa.me/31642221525"
        ],
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "4.9",
          "reviewCount": "127",
          "bestRating": "5",
          "worstRating": "1"
        }
      }
    </script>
  </head>

  <body>
    <!-- Navigation Header -->
    <Header
      logoText={t("site.name", "Jasmine Tours")}
      logoHref={`/`}
      navItems={[
        {
          label: t("nav.features", "Экскурсии"),
          href: `/#tours`,
        },
        {
          label: t("nav.team", "Отзывы"),
          href: `/#testimonials`,
        },
        { label: t("nav.about", "Обо мне"), href: `/about-me` },
        {
          label: t("nav.contact", "Связаться"),
          href: `#contact`,
        },
      ]}
      fixed={true}
      showLanguageSwitcher={false}
      currentLocale={activeLocale}
    />

    <main>
      <slot />
    </main>

    <!-- Footer -->
    <Footer
      locale={activeLocale}
      logoText={t("site.name", "Jasmine Tours & Events")}
      logoHref={`/`}
      copyrightText={t(
        "footer.copyright",
        "© 2025 Jasmine Tours & Events. Все права защищены.",
      )}
      showNewsletter={true}
      newsletterTitle={t("footer.newsletter.title", "Будьте в курсе")}
      newsletterDescription={t(
        "footer.newsletter.description",
        "Получайте последние новости и обновления на вашу электронную почту.",
      )}
    />

    <Toaster client:load />
    <!-- Simple Scroll Animations (fallback for older browsers) -->
    <script src="/src/utils/scroll-animations.ts"></script>
  </body>
</html>
