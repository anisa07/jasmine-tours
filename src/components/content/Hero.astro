---
import { getPageTranslations } from "@/i18n/i18n";
import type { Locale } from "@/i18n/config";
import { cn } from "@/lib/utils";
import { Search, ChevronDown } from "@lucide/astro";
import { Image } from "astro:assets";
import type { ImageType } from "@/types";

export interface HeroAction {
  label: string;
  href: string;
  variant?: 'primary' | 'secondary' | 'outline';
  external?: boolean;
  icon?: string;
}

export interface Props {
  title: string;
  subtitle?: string;
  description?: string;
  actions?: HeroAction[];
  variant?: 'default' | 'centered' | 'split' | 'minimal' | 'gradient';
  backgroundImage?: string;
  backgroundVideo?: string;
  overlayOpacity?: number;
  textAlign?: 'left' | 'center' | 'right';
  maxWidth?: 'sm' | 'md' | 'lg' | 'xl' | '2xl' | 'full';
  class?: string;
  locale?: Locale;
  images: {
    mainImage: ImageType,
    mainImageAlt: string,
    secondaryImage:ImageType,
    secondaryImageAlt:string,
  },
}

const {
  title,
  subtitle,
  description,
  actions = [],
  variant = 'default',
  backgroundImage,
  backgroundVideo,
  overlayOpacity = 0.4,
  textAlign = 'left',
  maxWidth = 'xl',
  class: className = "",
  locale = "ru",
  images
} = Astro.props;

// Get translations
const { t } = await getPageTranslations(locale, ["hero", "common"]);

const getActionButtonClasses = (actionVariant: string = 'primary') => {
  const baseClasses = "inline-flex items-center justify-center px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2";
  
  switch (actionVariant) {
    case 'secondary':
      return cn(baseClasses, "bg-secondary text-secondary-foreground hover:bg-secondary/90 focus:ring-secondary");
    case 'outline':
      return cn(baseClasses, "border-2 border-primary text-primary bg-transparent hover:bg-primary hover:text-primary-foreground focus:ring-primary");
    default:
      return cn(baseClasses, "bg-primary text-primary-foreground hover:bg-primary/90 focus:ring-primary");
  }
};

const sectionClasses = cn(
  "relative",
  variant === 'minimal' ? 'py-12 md:py-16' : 'py-20 md:py-28 lg:py-32',
  variant === 'gradient' ? 'bg-gradient-to-br from-primary/10 via-background to-primary/20' : 'bg-background',
  variant === 'split' ? "bg-primary/10" : 'bg-background',
  className
);

---

<section class={sectionClasses}>
  <!-- Background Elements -->
  {backgroundImage && (
    <div class="absolute inset-0 z-0">
      <Image
        src={backgroundImage}
        alt="Amsterdam tours background - Canal views and historic architecture"
        class="w-full h-full object-cover"
        loading="eager"
        width={2048}
        height={1365}
        format="webp"
        quality={80}
      />
      <div 
        class="absolute inset-0 bg-background" 
        style={`opacity: ${overlayOpacity}`}
      ></div>
    </div>
  )}

  {backgroundVideo && (
    <div class="absolute inset-0 z-0">
      <video
        class="w-full h-full object-cover"
        autoplay
        muted
        loop
        playsinline
      >
        <source src={backgroundVideo} type="video/mp4" />
      </video>
      <div 
        class="absolute inset-0 bg-background" 
        style={`opacity: ${overlayOpacity}`}
      ></div>
    </div>
  )}

  <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    {variant === 'split' ? (
      // Split Layout - Text Left, Images Right
      <div class="grid lg:grid-cols-12 gap-6 sm:gap-8 lg:gap-16 items-center min-h-[60vh]">
        <div class="lg:col-span-5 space-y-4 sm:space-y-6 px-2 sm:px-0">
          {subtitle && (
            <div class="inline-flex items-center text-sm font-medium text-foreground/70 uppercase tracking-wider">
              <span class="w-8 h-px bg-muted-foreground mr-3"></span>
              {subtitle}
            </div>
          )}
          
          <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-foreground leading-tight">
            {title}
          </h1>
          
          {description && (
            <p class="text-base sm:text-lg text-muted-foreground leading-relaxed max-w-lg">
              {description}
            </p>
          )}

          {/* Search Bar */}
          <div class="flex mt-6 sm:mt-8">
            <div class="flex-1 relative">
              <input
                id="hero-search-input"
                type="text"
                placeholder={t("hero.search_placeholder", "Куда вы хотели бы отправиться?")}
                class="w-full px-3 sm:px-4 py-2.5 sm:py-3 text-sm sm:text-base border border-border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <button
              id="hero-search-button"
              type="button"
              class="px-4 sm:px-6 py-2.5 sm:py-3 bg-primary text-primary-foreground rounded-r-lg hover:bg-primary/90 transition-colors"
              aria-label={t("hero.search_button", "Search tours")}
            >
              <Search size={18} class="sm:hidden" aria-hidden="true" />
              <Search size={20} class="hidden sm:block" aria-hidden="true" />
            </button>
          </div>

          {actions.length > 0 && (
            <div class="flex flex-col sm:flex-row flex-wrap gap-3 sm:gap-4 pt-4">
              {actions.map((action) => (
                <a
                  href={action.href}
                  class={getActionButtonClasses(action.variant)}
                  target={action.external ? '_blank' : undefined}
                  rel={action.external ? 'noopener noreferrer' : undefined}
                >
                  {action.icon && (
                    <span class="mr-2" aria-hidden="true">{action.icon}</span>
                  )}
                  {action.label}
                  {action.external && (
                    <span class="ml-2 text-sm" aria-hidden="true">↗</span>
                  )}
                </a>
              ))}
            </div>
          )}
        </div>

        {/* Image Carousel Section */}
        <div class="lg:col-span-7 relative mt-8 lg:mt-0 px-2 sm:px-0">
          <slot name="media">
            <div class="relative h-[300px] sm:h-[350px] lg:h-[500px]">
              {/* Main Image Container */}
              <div class="w-full h-[300px] sm:h-[350px] lg:h-[500px] rounded-xl sm:rounded-2xl shadow-xl sm:shadow-2xl overflow-hidden">
                <Image
                  src={images.mainImage}
                  alt={images.mainImageAlt}
                  class="w-full hero-main-image object-cover"
                  loading="eager"
                />
              </div>
              
              {/* Secondary Image - Floating */}
              <div class="absolute -right-2 -bottom-2 sm:-right-4 sm:-bottom-4 lg:-right-8 lg:-bottom-8 w-32 h-20 sm:w-48 sm:h-32 lg:w-64 lg:h-40 rounded-lg sm:rounded-xl shadow-lg sm:shadow-xl border-2 sm:border-4 border-background overflow-hidden">
                <Image
                  src={images.secondaryImage}
                  alt={images.secondaryImageAlt}
                  class="w-full h-full object-cover rounded-lg sm:rounded-xl"
                  loading="eager"
                />
              </div>
            </div>
          </slot>
        </div>
      </div>
    ) : (
      // Standard Layouts (default, centered, minimal, gradient)
      <div class={cn(
        "space-y-8",
        variant === 'centered' ? 'text-center mx-auto' : `text-${textAlign}`,
        variant === 'centered' && 'max-w-4xl'
      )}>
        {subtitle && (
          <div class={cn(
            "inline-flex items-center px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium",
            variant === 'centered' && 'mx-auto'
          )}>
            {subtitle}
          </div>
        )}
        
        <h1 class={cn(
          "font-bold text-foreground leading-tight",
          variant === 'minimal' 
            ? 'text-3xl md:text-4xl lg:text-5xl' 
            : 'text-4xl md:text-5xl lg:text-6xl xl:text-7xl'
        )}>
          {title}
        </h1>
        
        {description && (
          <p class={cn(
            "text-muted-foreground leading-relaxed",
            variant === 'minimal' 
              ? 'text-base md:text-lg' 
              : 'text-lg md:text-xl lg:text-2xl',
            `max-w-${maxWidth}`,
            (variant === 'centered' || textAlign === 'center') && 'mx-auto'
          )}>
            {description}
          </p>
        )}

        {actions.length > 0 && (
          <div class={cn(
            "flex flex-wrap gap-4 pt-4",
            variant === 'centered' || textAlign === 'center' 
              ? 'justify-center' 
              : textAlign === 'right' 
                ? 'justify-end' 
                : 'justify-start'
          )}>
            {actions.map((action) => (
              <a
                href={action.href}
                class={getActionButtonClasses(action.variant)}
                target={action.external ? '_blank' : undefined}
                rel={action.external ? 'noopener noreferrer' : undefined}
              >
                {action.icon && (
                  <span class="mr-2" aria-hidden="true">{action.icon}</span>
                )}
                {action.label}
                {action.external && (
                  <span class="ml-2 text-sm" aria-hidden="true">↗</span>
                )}
              </a>
            ))}
          </div>
        )}

        <!-- Default Media Slot -->
        {variant !== 'minimal' && (
          <div class="pt-8">
            <slot name="media" />
          </div>
        )}
      </div>
    )}

    <!-- Additional Content Slot -->
    <slot name="content" />
  </div>

  <!-- Decorative Elements for Gradient Variant -->
  {variant === 'gradient' && (
    <>
      <div class="absolute top-10 left-10 w-72 h-72 bg-primary/5 rounded-full blur-3xl"></div>
      <div class="absolute bottom-10 right-10 w-96 h-96 bg-secondary/5 rounded-full blur-3xl"></div>
    </>
  )}

  <!-- Scroll Indicator -->
  <div class="absolute bottom- left-1/2 transform -translate-x-1/2 animate-bounce">
    <slot name="scroll-indicator">
      {variant !== 'minimal' && (
        <button
          type="button"
          class="inline-flex items-center justify-center w-8 h-8 text-muted-foreground hover:text-foreground transition-colors"
          aria-label={t("hero.scroll_down", "Scroll down")}
          onclick="window.scrollTo({ top: window.innerHeight - 200, behavior: 'smooth' })"
        >
          <ChevronDown size={20} aria-hidden="true" />
        </button>
      )}
    </slot>
  </div>
</section>

<style>
  /* Smooth scroll behavior */
  html {
    scroll-behavior: smooth;
  }
  
  /* Animation for gradient backgrounds */
  @keyframes gradient-shift {
    0%, 100% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
  }
  
  .bg-gradient-to-br {
    background-size: 200% 200%;
    animation: gradient-shift 15s ease infinite;
  }
  
  /* Ensure video backgrounds don't interfere with text */
  video {
    pointer-events: none;
  }
  
  /* Focus styles for action buttons */
  .focus\:ring-primary:focus {
    --tw-ring-color: rgb(var(--color-primary) / var(--tw-ring-opacity));
  }
  
  .focus\:ring-secondary:focus {
    --tw-ring-color: rgb(var(--color-secondary) / var(--tw-ring-opacity));
  }
  
  /* Search input focus styles */
  .search-input:focus {
    box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.1);
  }
  
  /* Hero image constraints */
  .hero-main-image {
    max-height: 300px;
    min-height: 300px;
    height: 300px;
  }
  
  @media (min-width: 640px) {
    .hero-main-image {
      max-height: 350px;
      min-height: 350px;
      height: 350px;
    }
  }
  
  @media (min-width: 1024px) {
    .hero-main-image {
      max-height: 500px;
      min-height: 500px;
      height: 500px;
    }
  }
</style>

<script is:inline>
  // Hero search functionality
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("hero-search-input");
    const searchButton = document.getElementById("hero-search-button");

    function performSearch() {
      const searchTerm = searchInput?.value?.trim().toLowerCase();
      if (!searchTerm) return;

      // Scroll to tours section
      const toursSection = document.getElementById("tours");
      if (toursSection) {
        toursSection.scrollIntoView({ behavior: "smooth" });
      }

      // Trigger search in TourFilter component
      setTimeout(() => {
        if (window.searchTours) {
          window.searchTours(searchTerm);
        }
      }, 500); // Small delay to ensure smooth scroll
    }

    // Search button click
    searchButton?.addEventListener("click", performSearch);

    // Enter key press
    searchInput?.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        performSearch();
      }
    });
  });
</script>