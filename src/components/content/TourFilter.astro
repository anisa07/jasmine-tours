---
import Container from "@/components/layout/Container.astro";
import TourFilterCard from "@/components/content/TourFilterCard.astro";
import type { ImageType } from "@/types";

// Type definitions
type Tour = {
  title: string;
  price: string;
  duration: string;
  image: ImageType;
  alt: string;
  slug?: string;
};

type TourCategory = {
  id: string;
  title: string;
  tours: Tour[];
};

type TourCategories = TourCategory[];

interface Props {
  t: (
    key: string,
    fallback: string,
    vars?: Record<string, string | number>
  ) => string;
  tourCategories: TourCategories;
  locale?: string;
}

const { t, tourCategories: rawTourCategories, locale = "ru" } = Astro.props;

// Apply translations to tour categories
const tourCategories = rawTourCategories.map(category => ({
  ...category,
  title: t(`tours.filters.${category.id}`, category.title)
}));
---

<!-- Tour Filter Panel Section -->
<section class="py-16 bg-card/50 border-y">
  <Container size="xl" padding="lg">
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-4xl font-bold text-foreground mb-4">
        Познакомьтесь с нашими турами
      </h2>
      <p class="text-lg text-muted-foreground max-w-2xl mx-auto">
        Откройте удивительные впечатления с нашими тщательно продуманными туристическими программами
      </p>
    </div>

    <!-- Filter Tabs -->
    <div class="flex flex-wrap justify-center gap-2 mb-8">
      {tourCategories.map((category, index) => (
        <button
          class={`tour-filter-tab px-6 py-3 rounded-full border-2 font-semibold transition-all duration-200 hover:shadow-md ${
            index === 0 
              ? 'active border-primary bg-primary text-primary-foreground' 
              : 'border-border bg-background text-foreground hover:border-primary hover:text-primary'
          }`}
          data-filter={category.id}
        >
          {category.title}
        </button>
      ))}
    </div>

    <!-- Tour Content Area -->
    <div class="tour-content-area">
      {tourCategories.map((category, categoryIndex) => (
        <div 
          id={`${category.id}-tours`} 
          class={`tour-content ${categoryIndex === 0 ? 'active' : 'hidden'}`}
        >
          <!-- Tours Grid -->
          <div 
            class="tours-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"
            data-category={category.id}
          >
            {category.tours.map((tour, tourIndex) => (
              <div 
                class={`tour-card ${tourIndex >= 3 ? 'hidden' : ''}`}
                data-tour-index={tourIndex}
              >
                <TourFilterCard
                  title={tour.title}
                  price={tour.price}
                  duration={tour.duration}
                  image={tour.image}
                  alt={tour.alt}
                  tourSlug={tour.slug}
                  locale={locale}
                />
              </div>
            ))}
          </div>

          <!-- More Tours Button -->
          {category.tours.length > 3 && (
            <div class="text-center">
              <button
                class="more-tours-btn px-8 py-3 bg-primary text-primary-foreground rounded-full font-semibold hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg"
                data-category={category.id}
              >
                Показать больше туров ({category.tours.length - 3})
              </button>
              <button
                class="less-tours-btn hidden px-8 py-3 bg-muted text-muted-foreground rounded-full font-semibold hover:bg-muted/80 transition-all duration-200 shadow-md hover:shadow-lg ml-4"
                data-category={category.id}
              >
                Показать меньше
              </button>
            </div>
          )}
        </div>
      ))}
    </div>
  </Container>
</section>

<style>
    .tour-card {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }
    .tour-card.hidden {
        display: none;
    }
    .tour-card.showing {
        animation: fadeInUp 0.5s ease-out forwards;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script is:inline>
  // Tour filter tab functionality + Grid expand/collapse functionality
  document.addEventListener("DOMContentLoaded", function () {
    const filterTabs = document.querySelectorAll(".tour-filter-tab");
    const tourContents = document.querySelectorAll(".tour-content");

    // Grid expansion states for each category
    const gridStates = {};
    document.querySelectorAll('[data-category]').forEach((grid) => {
      const category = grid.getAttribute('data-category');
      gridStates[category] = { expanded: false };
    });

    function switchTab(targetFilter) {
      // Remove active class from all tabs
      for (let i = 0; i < filterTabs.length; i++) {
        const tab = filterTabs[i];
        tab.classList.remove("active");
        tab.classList.remove(
          "border-primary",
          "bg-primary",
          "text-primary-foreground"
        );
        tab.classList.add("border-border", "bg-background", "text-foreground");
      }

      // Hide all tour content
      for (let i = 0; i < tourContents.length; i++) {
        const content = tourContents[i];
        content.classList.remove("active");
        content.classList.add("hidden");
      }

      // Add active class to clicked tab
      const activeTab = document.querySelector(
        '[data-filter="' + targetFilter + '"]'
      );
      if (activeTab) {
        activeTab.classList.add("active");
        activeTab.classList.remove(
          "border-border",
          "bg-background",
          "text-foreground"
        );
        activeTab.classList.add(
          "border-primary",
          "bg-primary",
          "text-primary-foreground"
        );
      }

      // Show corresponding content
      const activeContent = document.getElementById(targetFilter + "-tours");
      if (activeContent) {
        activeContent.classList.add("active");
        activeContent.classList.remove("hidden");
        
        // Reset grid state when switching tabs
        if (gridStates[targetFilter] && gridStates[targetFilter].expanded) {
          collapseGrid(targetFilter);
        }
      }
    }

    function expandGrid(category) {
      const grid = document.querySelector(`[data-category="${category}"]`);
      const moreBtn = document.querySelector(`.more-tours-btn[data-category="${category}"]`);
      const lessBtn = document.querySelector(`.less-tours-btn[data-category="${category}"]`);
      
      if (grid) {
        const hiddenCards = grid.querySelectorAll('.tour-card.hidden');
        
        hiddenCards.forEach((card, index) => {
          setTimeout(() => {
            card.classList.remove('hidden');
            card.classList.add('showing');
          }, index * 100); // Staggered animation
        });
        
        if (moreBtn) moreBtn.style.display = 'none';
        if (lessBtn) lessBtn.style.display = 'inline-block';
        
        gridStates[category].expanded = true;
      }
    }

    function collapseGrid(category) {
      const grid = document.querySelector(`[data-category="${category}"]`);
      const moreBtn = document.querySelector(`.more-tours-btn[data-category="${category}"]`);
      const lessBtn = document.querySelector(`.less-tours-btn[data-category="${category}"]`);
      
      if (grid) {
        const allCards = grid.querySelectorAll('.tour-card');
        
        allCards.forEach((card, index) => {
          if (index >= 3) {
            card.classList.remove('showing');
            card.classList.add('hidden');
          }
        });
        
        if (moreBtn) moreBtn.style.display = 'inline-block';
        if (lessBtn) lessBtn.style.display = 'none';
        
        gridStates[category].expanded = false;
      }
    }

    // Add click event listeners to all tabs
    for (let i = 0; i < filterTabs.length; i++) {
      const tab = filterTabs[i];
      tab.addEventListener("click", function () {
        const filter = tab.getAttribute("data-filter");
        if (filter) {
          switchTab(filter);
        }
      });
    }

    // Add grid expansion event listeners
    document.addEventListener("click", function (e) {
      // More tours button
      if (e.target.closest(".more-tours-btn")) {
        const category = e.target.closest(".more-tours-btn").getAttribute("data-category");
        expandGrid(category);
      }

      // Less tours button
      if (e.target.closest(".less-tours-btn")) {
        const category = e.target.closest(".less-tours-btn").getAttribute("data-category");
        collapseGrid(category);
      }
    });

    // Global search function that can be called from Hero component
    window.searchTours = function(searchTerm) {
      let foundResults = false;
      let matchingCategory = null;

      // Search through all tours in all categories
      document.querySelectorAll('[data-category]').forEach((grid) => {
        const category = grid.getAttribute('data-category');
        const categoryTours = grid.querySelectorAll('.tour-card');
        let hasMatchInCategory = false;

        categoryTours.forEach((card) => {
          // Look for tour title in the card
          const titleElement = card.querySelector('h3, .font-semibold');
          const title = titleElement?.textContent?.toLowerCase() || '';
          
          if (title.includes(searchTerm)) {
            hasMatchInCategory = true;
            foundResults = true;
            // Highlight the card
            card.style.border = '2px solid rgb(59, 130, 246)'; // primary color
            card.style.transform = 'scale(1.02)';
            card.style.transition = 'all 0.3s ease';
            setTimeout(() => {
              card.style.border = '';
              card.style.transform = '';
            }, 2000);
          }
        });

        if (hasMatchInCategory && !matchingCategory) {
          matchingCategory = category;
        }
      });

      // Switch to the category with matches
      if (matchingCategory) {
        switchTab(matchingCategory);
        
        // Expand the grid to show all tours if collapsed
        if (!gridStates[matchingCategory].expanded) {
          setTimeout(() => {
            expandGrid(matchingCategory);
          }, 300);
        }
      }

      // Show no results message if nothing found
      if (!foundResults) {
        // Create or show no results message
        let noResultsMsg = document.getElementById('no-search-results');
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.id = 'no-search-results';
          noResultsMsg.className = 'text-center py-8 text-muted-foreground';
          noResultsMsg.innerHTML = `<p class="text-lg">No tours found for "${searchTerm}". Try searching for destinations like "Amsterdam", "Labuan Bajo", or activities like "boat", "mountain".</p>`;
          
          const tourContentArea = document.querySelector('.tour-content-area');
          if (tourContentArea) {
            tourContentArea.appendChild(noResultsMsg);
          }
        } else {
          noResultsMsg.innerHTML = `<p class="text-lg">No tours found for "${searchTerm}". Try searching for destinations like "Amsterdam", "Labuan Bajo", or activities like "boat", "mountain".</p>`;
          noResultsMsg.style.display = 'block';
        }
        
        // Hide the message after 3 seconds
        setTimeout(() => {
          if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
          }
        }, 3000);
      } else {
        // Hide no results message if it exists
        const noResultsMsg = document.getElementById('no-search-results');
        if (noResultsMsg) {
          noResultsMsg.style.display = 'none';
        }
      }
    };
  });
</script>
