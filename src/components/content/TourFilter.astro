---
import Container from "@/components/layout/Container.astro";
import TourFilterCard from "@/components/content/TourFilterCard.astro";
import type { ImageMetadata } from "astro";
import WhatsAppIcon from "@/assets/images/svg/whatsapp.svg?raw";
import FacebookIcon from "@/assets/images/svg/facebook.svg?raw";
import TwitterIcon from "@/assets/images/svg/twitter.svg?raw";
import InstagramIcon from "@/assets/images/svg/instagram.svg?raw";
import WhatsAppContactIcon from "@/assets/images/svg/whatsapp-contact.svg?raw";
import { X, ChevronLeft, ChevronRight } from "@lucide/astro";

// Type definitions
type Tour = {
  title: string;
  price: string;
  duration: string;
  image: ImageMetadata;
  alt: string;
  slug?: string;
  description?: string;
};

type TourCategory = {
  id: string;
  title: string;
  tours: Tour[];
};

type TourCategories = TourCategory[];

interface Props {
  t: (
    key: string,
    fallback: string,
    vars?: Record<string, string | number>
  ) => string;
  tourCategories: TourCategories;
  locale?: string;
}

const { t, tourCategories: rawTourCategories, locale = "ru" } = Astro.props;

// Apply translations to tour categories
const tourCategories = rawTourCategories.map(category => ({
  ...category,
  title: t(`tours.filters.${category.id}`, category.title)
}));
---

<!-- Tour Filter Panel Section -->
<section class="py-16 bg-card/50 border-y">
  <Container size="xl" padding="lg">
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-4xl font-bold text-foreground mb-4">
        Познакомьтесь с нашими турами
      </h2>
      <p class="text-lg text-muted-foreground max-w-2xl mx-auto">
        Откройте удивительные впечатления с нашими тщательно продуманными туристическими программами
      </p>
    </div>

    <!-- Filter Tabs -->
    <div class="flex flex-wrap justify-center gap-2 mb-8">
      {tourCategories.map((category, index) => (
        <button
          class={`tour-filter-tab px-6 py-3 rounded-full border-2 font-semibold transition-all duration-200 hover:shadow-md ${
            index === 0 
              ? 'active border-primary bg-primary text-primary-foreground' 
              : 'border-border bg-background text-foreground'
          }`}
          data-filter={category.id}
        >
          {category.title}
        </button>
      ))}
    </div>

    <!-- Tour Content Area -->
    <div class="tour-content-area">
      {tourCategories.map((category, categoryIndex) => (
        <div 
          id={`${category.id}-tours`} 
          class={`tour-content ${categoryIndex === 0 ? 'active' : 'hidden'}`}
        >
          <!-- Tours Grid -->
          <div 
            class="tours-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"
            data-category={category.id}
          >
            {category.tours.map((tour, tourIndex) => (
              <div 
                class={`tour-card ${tourIndex >= 3 ? 'hidden' : ''}`}
                data-tour-index={tourIndex}
              >
                <TourFilterCard
                  title={tour.title}
                  price={tour.price}
                  duration={tour.duration}
                  image={tour.image}
                  alt={tour.alt}
                  tourSlug={tour.slug}
                  locale={locale}
                  description={tour.description}
                />
              </div>
            ))}
          </div>

          <!-- More Tours Button -->
          {category.tours.length > 3 && (
            <div class="text-center">
              <button
                class="more-tours-btn px-8 py-3 bg-primary text-primary-foreground rounded-full font-semibold hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg"
                data-category={category.id}
              >
                Показать больше туров ({category.tours.length - 3})
              </button>
              <button
                class="less-tours-btn hidden px-8 py-3 bg-muted text-muted-foreground rounded-full font-semibold hover:bg-muted/80 transition-all duration-200 shadow-md hover:shadow-lg ml-4"
                data-category={category.id}
              >
                Показать меньше
              </button>
            </div>
          )}
        </div>
      ))}
    </div>
  </Container>

  <!-- Tour Details Modal -->
  <div id="tourModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="relative flex items-center justify-center w-full max-w-4xl">
      <!-- Previous Button - Desktop/Tablet (left side) -->
      <button id="prevTourBtn" class="tour-nav-btn tour-nav-btn-left hidden sm:flex" aria-label="Previous tour">
        <ChevronLeft class="w-6 h-6" />
      </button>

      <div class="bg-background rounded-2xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
        <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-border flex-shrink-0">
        <h2 id="modalTitle" class="text-2xl font-bold text-foreground"></h2>
        <button id="closeModal" class="p-2 hover:bg-muted rounded-full transition-colors">
          <X class="w-6 h-6" />
        </button>
      </div>
      
      <!-- Modal Content - Scrollable Area -->
      <div class="overflow-y-auto flex-1 p-6">
        <!-- Price and Duration -->
        <div class="flex items-center justify-between mb-6 p-4 bg-muted/50 rounded-lg">
          <div>
            <div id="modalPrice" class="text-2xl font-bold text-primary"></div>
            <div class="text-sm text-muted-foreground">за тур</div>
          </div>
          <div>
            <div id="modalDuration" class="text-lg font-semibold"></div>
            <div class="text-sm text-muted-foreground">продолжительность</div>
          </div>
        </div>
        
        <!-- Description -->
        <div id="modalDescription" class="prose prose-sm max-w-none modal-content mb-6"></div>
      </div>
      
      <!-- Contact Button and Share Links - Fixed at bottom -->
      <div class="flex-shrink-0 p-6 border-t border-border">
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <!-- WhatsApp Contact Button -->
          <a 
            href="https://wa.me/c/31642221525" 
            target="_blank"
            class="flex-1 py-3 px-6 bg-primary text-primary-foreground rounded-lg font-semibold hover:bg-primary/90 transition-colors flex items-center justify-center gap-2"
          >
            <div class="w-5 h-5" set:html={WhatsAppContactIcon} />
            Связаться через WhatsApp
          </a>
          
          <!-- Share and Navigation Buttons -->
          <div class="flex gap-2 items-center justify-center sm:justify-start flex-shrink-0">
            <!-- Mobile Navigation - Previous (hidden on desktop/tablet) -->
            <button id="prevTourBtnMobile" class="tour-nav-btn-mobile sm:hidden" aria-label="Previous tour">
              <ChevronLeft class="w-5 h-5" />
            </button>

            <!-- WhatsApp Share -->
            <button 
              class="share-btn share-whatsapp"
              aria-label="Share on WhatsApp"
              title="Поделиться в WhatsApp"
            >
              <div class="share-icon" set:html={WhatsAppIcon} />
            </button>
            
            <!-- Facebook Share -->
            <button 
              class="share-btn share-facebook"
              aria-label="Share on Facebook"
              title="Поделиться в Facebook"
            >
              <div class="share-icon" set:html={FacebookIcon} />
            </button>
            
            <!-- X (Twitter) Share -->
            <button 
              class="share-btn share-twitter"
              aria-label="Share on X (Twitter)"
              title="Поделиться в X"
            >
              <div class="share-icon" set:html={TwitterIcon} />
            </button>
            
            <!-- Instagram (Copy Link) -->
            <button 
              class="share-btn share-instagram"
              aria-label="Copy link to share on Instagram"
              title="Скопировать ссылку"
            >
              <div class="share-icon" set:html={InstagramIcon} />
            </button>

            <!-- Mobile Navigation - Next (hidden on desktop/tablet) -->
            <button id="nextTourBtnMobile" class="tour-nav-btn-mobile sm:hidden" aria-label="Next tour">
              <ChevronRight class="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>

      <!-- Next Button - Desktop/Tablet (right side) -->
      <button id="nextTourBtn" class="tour-nav-btn tour-nav-btn-right hidden sm:flex" aria-label="Next tour">
        <ChevronRight class="w-6 h-6" />
      </button>
    </div>
  </div>
</section>

<style>
    /* Tour filter button styles */
    .tour-filter-tab:not(.active):hover {
        color: hsl(var(--primary));
        border-color: hsl(var(--primary));
    }
    
    .tour-filter-tab.active {
        /* Ensure active buttons don't change on hover */
        color: hsl(var(--primary-foreground)) !important;
        background-color: hsl(var(--primary)) !important;
        border-color: hsl(var(--primary)) !important;
    }
    
    .tour-card {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }
    .tour-card.hidden {
        display: none;
    }
    .tour-card.showing {
        animation: fadeInUp 0.5s ease-out forwards;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Modal specific styles for build version */
    #tourModal {
        overflow-y: auto !important;
    }
    
    #tourModal .bg-background {
        max-height: 90vh !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    #tourModal .overflow-y-auto {
        overflow-y: auto !important;
        flex: 1 !important;
        min-height: 0 !important;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Modal content styling */
    .modal-content h2 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-top: 1.25rem;
        margin-bottom: 0.5rem;
        color: hsl(var(--foreground));
    }
    .modal-content h2:first-child {
        margin-top: 0;
    }
    .modal-content h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.25rem;
        color: hsl(var(--foreground));
    }
    .modal-content p {
        margin-bottom: 0.75rem;
        font-size: 1rem;
        color: hsl(var(--muted-foreground));
        line-height: 1.625;
    }
    .modal-content ul {
        margin-bottom: 0.75rem;
        margin-top: 0.25rem;
    }
    .modal-content li {
        font-size: 1rem;
        color: hsl(var(--muted-foreground));
        line-height: 1.625;
        margin-bottom: 0.25rem;
    }
    .modal-content strong {
        font-weight: 600;
        font-size: 1rem;
        color: hsl(var(--foreground));
    }
    .modal-content em {
        font-style: italic;
        font-size: 1rem;
    }
    
    /* Share buttons styling */
    .share-btn {
        width: 48px;
        height: 48px;
        min-width: 48px;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        cursor: pointer;
        border: none;
    }
    
    .share-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }
    
    .share-btn:active {
        transform: scale(0.95);
    }
    
    .share-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .share-icon :global(svg) {
        width: 100%;
        height: 100%;
    }
    
    /* Individual button colors */
    .share-whatsapp {
        background-color: #25D366;
    }
    
    .share-whatsapp:hover {
        background-color: #20BA5A;
    }
    
    .share-facebook {
        background-color: #1877F2;
    }
    
    .share-facebook:hover {
        background-color: #166FE5;
    }
    
    .share-twitter {
        background-color: #000000;
    }
    
    .share-twitter:hover {
        background-color: #1a1a1a;
    }
    
    .share-instagram {
        background: linear-gradient(135deg, #833AB4 0%, #E1306C 50%, #F56040 100%);
    }
    
    .share-instagram:hover {
        opacity: 0.9;
    }
    
    /* Tour navigation buttons - Desktop/Tablet (hidden on mobile) */
    .tour-nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: hsl(var(--background));
        border: 2px solid hsl(var(--border));
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        z-index: 10;
    }
    
    .tour-nav-btn:hover {
        background-color: hsl(var(--muted));
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    
    .tour-nav-btn:active {
        transform: translateY(-50%) scale(0.95);
    }
    
    .tour-nav-btn-left {
        left: -25px;
    }
    
    .tour-nav-btn-right {
        right: -25px;
    }
    
    .tour-nav-btn :global(svg) {
        color: hsl(var(--foreground));
    }
    
    /* Hide desktop/tablet navigation on mobile */
    @media (max-width: 640px) {
        .tour-nav-btn {
            display: none;
        }
    }
    
    /* Mobile navigation buttons - Inline with share buttons (mobile only) */
    .tour-nav-btn-mobile {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: hsl(var(--background));
        border: 2px solid hsl(var(--border));
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        flex-shrink: 0;
    }
    
    .tour-nav-btn-mobile:hover {
        background-color: hsl(var(--muted));
        transform: scale(1.1);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    
    .tour-nav-btn-mobile:active {
        transform: scale(0.95);
    }
    
    .tour-nav-btn-mobile :global(svg) {
        color: hsl(var(--foreground));
    }
    
    /* Hide mobile navigation buttons on desktop/tablet */
    @media (min-width: 640px) {
        .tour-nav-btn-mobile {
            display: none;
        }
    }
    
    /* Share button animations */
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>

<script is:inline>
  // Tour filter tab functionality + Grid expand/collapse functionality
  document.addEventListener("DOMContentLoaded", function () {
    const filterTabs = document.querySelectorAll(".tour-filter-tab");
    const tourContents = document.querySelectorAll(".tour-content");

    // Grid expansion states for each category
    const gridStates = {};
    document.querySelectorAll('[data-category]').forEach((grid) => {
      const category = grid.getAttribute('data-category');
      gridStates[category] = { expanded: false };
    });

    function switchTab(targetFilter) {
      // Remove active class from all tabs and add hover states back
      for (let i = 0; i < filterTabs.length; i++) {
        const tab = filterTabs[i];
        tab.classList.remove("active");
        tab.classList.remove(
          "border-primary",
          "bg-primary",
          "text-primary-foreground"
        );
        tab.classList.add("border-border", "bg-background", "text-foreground");
      }

      // Hide all tour content
      for (let i = 0; i < tourContents.length; i++) {
        const content = tourContents[i];
        content.classList.remove("active");
        content.classList.add("hidden");
      }

      // Add active class to clicked tab
      const activeTab = document.querySelector(
        '[data-filter="' + targetFilter + '"]'
      );
      if (activeTab) {
        activeTab.classList.add("active");
        activeTab.classList.remove(
          "border-border",
          "bg-background",
          "text-foreground"
        );
        activeTab.classList.add(
          "border-primary",
          "bg-primary",
          "text-primary-foreground"
        );
      }

      // Show corresponding content
      const activeContent = document.getElementById(targetFilter + "-tours");
      if (activeContent) {
        activeContent.classList.add("active");
        activeContent.classList.remove("hidden");
        
        // Reset grid state when switching tabs
        if (gridStates[targetFilter] && gridStates[targetFilter].expanded) {
          collapseGrid(targetFilter);
        }
      }
    }

    function expandGrid(category) {
      const grid = document.querySelector(`[data-category="${category}"]`);
      const moreBtn = document.querySelector(`.more-tours-btn[data-category="${category}"]`);
      const lessBtn = document.querySelector(`.less-tours-btn[data-category="${category}"]`);
      
      if (grid) {
        const hiddenCards = grid.querySelectorAll('.tour-card.hidden');
        
        hiddenCards.forEach((card, index) => {
          setTimeout(() => {
            card.classList.remove('hidden');
            card.classList.add('showing');
          }, index * 100); // Staggered animation
        });
        
        if (moreBtn) moreBtn.style.display = 'none';
        if (lessBtn) lessBtn.style.display = 'inline-block';
        
        gridStates[category].expanded = true;
      }
    }

    function collapseGrid(category) {
      const grid = document.querySelector(`[data-category="${category}"]`);
      const moreBtn = document.querySelector(`.more-tours-btn[data-category="${category}"]`);
      const lessBtn = document.querySelector(`.less-tours-btn[data-category="${category}"]`);
      
      if (grid) {
        const allCards = grid.querySelectorAll('.tour-card');
        
        allCards.forEach((card, index) => {
          if (index >= 3) {
            card.classList.remove('showing');
            card.classList.add('hidden');
          }
        });
        
        if (moreBtn) moreBtn.style.display = 'inline-block';
        if (lessBtn) lessBtn.style.display = 'none';
        
        gridStates[category].expanded = false;
      }
    }

    // Add click event listeners to all tabs
    for (let i = 0; i < filterTabs.length; i++) {
      const tab = filterTabs[i];
      tab.addEventListener("click", function () {
        const filter = tab.getAttribute("data-filter");
        if (filter) {
          switchTab(filter);
        }
      });
    }

    // Add grid expansion and modal event listeners
    document.addEventListener("click", function (e) {
      // More tours button
      if (e.target.closest(".more-tours-btn")) {
        const category = e.target.closest(".more-tours-btn").getAttribute("data-category");
        expandGrid(category);
      }

      // Less tours button
      if (e.target.closest(".less-tours-btn")) {
        const category = e.target.closest(".less-tours-btn").getAttribute("data-category");
        collapseGrid(category);
      }

      // Tour details button
      if (e.target.closest(".tour-details-btn")) {
        const btn = e.target.closest(".tour-details-btn");
        const tourCard = btn.closest(".tour-card");
        
        // Get the category grid
        const categoryGrid = tourCard.closest('[data-category]');
        
        // Collect all tour cards in this category
        const tourCards = categoryGrid ? Array.from(categoryGrid.querySelectorAll('.tour-card')) : [tourCard];
        
        // Find the index of the current tour
        const tourIndex = tourCards.indexOf(tourCard);
        
        // Build array of all tours data
        const toursData = tourCards.map(card => {
          const detailsBtn = card.querySelector('.tour-details-btn');
          return {
            title: detailsBtn.getAttribute("data-tour-title"),
            price: detailsBtn.getAttribute("data-tour-price"),
            duration: detailsBtn.getAttribute("data-tour-duration"),
            description: detailsBtn.getAttribute("data-tour-description"),
            image: detailsBtn.getAttribute("data-tour-image"),
            alt: detailsBtn.getAttribute("data-tour-alt")
          };
        });
        
        // Open modal with current tour and navigation context
        openTourModal(toursData[tourIndex], tourIndex, toursData);
      }

      // Close modal button
      if (e.target.closest("#closeModal")) {
        closeTourModal();
      }

      // Close modal on backdrop click
      if (e.target.id === "tourModal") {
        closeTourModal();
      }
    });

    // Global search function that can be called from Hero component
    window.searchTours = function(searchTerm) {
      let foundResults = false;
      let matchingCategory = null;

      // Search through all tours in all categories
      document.querySelectorAll('[data-category]').forEach((grid) => {
        const category = grid.getAttribute('data-category');
        const categoryTours = grid.querySelectorAll('.tour-card');
        let hasMatchInCategory = false;

        categoryTours.forEach((card) => {
          // Look for tour title in the card
          const titleElement = card.querySelector('h3, .font-semibold');
          const title = titleElement?.textContent?.toLowerCase() || '';
          
          if (title.includes(searchTerm)) {
            hasMatchInCategory = true;
            foundResults = true;
            // Highlight the card
            card.style.border = '2px solid rgb(59, 130, 246)'; // primary color
            card.style.transform = 'scale(1.02)';
            card.style.transition = 'all 0.3s ease';
            setTimeout(() => {
              card.style.border = '';
              card.style.transform = '';
            }, 2000);
          }
        });

        if (hasMatchInCategory && !matchingCategory) {
          matchingCategory = category;
        }
      });

      // Switch to the category with matches
      if (matchingCategory) {
        switchTab(matchingCategory);
        
        // Expand the grid to show all tours if collapsed
        if (!gridStates[matchingCategory].expanded) {
          setTimeout(() => {
            expandGrid(matchingCategory);
          }, 300);
        }
      }

      // Show no results message if nothing found
      if (!foundResults) {
        // Create or show no results message
        let noResultsMsg = document.getElementById('no-search-results');
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.id = 'no-search-results';
          noResultsMsg.className = 'text-center py-8 text-muted-foreground';
          noResultsMsg.innerHTML = `<p class="text-lg">No tours found for "${searchTerm}". Try searching for destinations like "Amsterdam", "Labuan Bajo", or activities like "boat", "mountain".</p>`;
          
          const tourContentArea = document.querySelector('.tour-content-area');
          if (tourContentArea) {
            tourContentArea.appendChild(noResultsMsg);
          }
        } else {
          noResultsMsg.innerHTML = `<p class="text-lg">No tours found for "${searchTerm}". Try searching for destinations like "Amsterdam", "Labuan Bajo", or activities like "boat", "mountain".</p>`;
          noResultsMsg.style.display = 'block';
        }
        
        // Hide the message after 3 seconds
        setTimeout(() => {
          if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
          }
        }, 3000);
      } else {
        // Hide no results message if it exists
        const noResultsMsg = document.getElementById('no-search-results');
        if (noResultsMsg) {
          noResultsMsg.style.display = 'none';
        }
      }
    };

    // Modal functions
    let currentTourData = null; // Store current tour data for sharing
    let allTours = []; // Store all tours in current category
    let currentTourIndex = 0; // Current tour index
    
    function openTourModal(tourData, tourIndex = 0, tours = []) {
      currentTourData = tourData; // Save tour data for sharing
      currentTourIndex = tourIndex;
      allTours = tours;
      
      const modal = document.getElementById("tourModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalPrice = document.getElementById("modalPrice");
      const modalDuration = document.getElementById("modalDuration");
      const modalDescription = document.getElementById("modalDescription");
      const scrollableArea = modal?.querySelector(".overflow-y-auto");
      
      // Update navigation buttons state
      updateNavigationButtons();

      if (modal && modalTitle && modalPrice && modalDuration && modalDescription) {
        modalTitle.textContent = tourData.title;
        modalPrice.textContent = tourData.price || "По запросу";
        modalDuration.textContent = tourData.duration;
        
        // Convert markdown to HTML (enhanced conversion with better spacing)
        let htmlDescription = tourData.description || "Описание скоро будет добавлено.";
        
        // Clean up extra whitespace first
        htmlDescription = htmlDescription.replace(/\n\s+/g, '\n').trim();
        
        // Enhanced markdown conversion
        htmlDescription = htmlDescription
          // Headers
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          // Bold text patterns - handle both **text** and **text:**
          .replace(/\*\*([^*]+?):\*\*/g, '<strong>$1:</strong>')
          .replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>')
          // List items
          .replace(/^- (.*$)/gim, '<li>$1</li>')
          .replace(/^\* (.*$)/gim, '<li>$1</li>')
          // Convert double line breaks to paragraph breaks
          .replace(/\n\n+/g, '</p><p>')
          // Convert single line breaks to br tags
          .replace(/\n/g, '<br>');
        
        // Wrap consecutive list items in ul tags
        htmlDescription = htmlDescription.replace(/(<li>.*?<\/li>)(\s*<br>\s*<li>.*?<\/li>)*/gs, function(match) {
          return '<ul>' + match.replace(/<br>\s*/g, '') + '</ul>';
        });
        
        // Clean up any remaining breaks after closing tags
        htmlDescription = htmlDescription.replace(/<\/(h[23]|ul)><br>/g, '</$1>');
        
        // Wrap content in paragraphs if needed
        if (!htmlDescription.startsWith('<h2>') && !htmlDescription.startsWith('<h3>') && !htmlDescription.startsWith('<ul>')) {
          htmlDescription = '<p>' + htmlDescription + '</p>';
        } else {
          // Add p tags around text that follows headers but isn't in lists
          htmlDescription = htmlDescription.replace(/(<\/h[23]>)\s*([^<].*?)(?=<h[23]>|<ul>|$)/gs, '$1<p>$2</p>');
        }
        
        // Final cleanup - remove excessive breaks and empty paragraphs
        htmlDescription = htmlDescription
          .replace(/<br>\s*<\/p>/g, '</p>')
          .replace(/<p>\s*<br>/g, '<p>')
          .replace(/<p>\s*<\/p>/g, '')
          .replace(/(<\/ul>)\s*<br>/g, '$1');
        
        modalDescription.innerHTML = htmlDescription;
        
        // Reset scroll position to top before showing modal
        if (scrollableArea) {
          scrollableArea.scrollTop = 0;
        }
        
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.style.overflow = "hidden";
      }
    }

    function closeTourModal() {
      const modal = document.getElementById("tourModal");
      if (modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        document.body.style.overflow = "auto";
      }
    }

    // Navigation functions
    function updateNavigationButtons() {
      // No need to disable buttons since we're wrapping around
      // Buttons are always enabled when there's more than 1 tour
    }

    function navigateToTour(direction) {
      if (allTours.length <= 1) return; // No navigation if only 1 tour
      
      let newIndex;
      if (direction === 'prev') {
        // Wrap to last tour if at first tour
        newIndex = currentTourIndex === 0 ? allTours.length - 1 : currentTourIndex - 1;
      } else {
        // Wrap to first tour if at last tour
        newIndex = currentTourIndex === allTours.length - 1 ? 0 : currentTourIndex + 1;
      }
      
      const newTourData = allTours[newIndex];
      openTourModal(newTourData, newIndex, allTours);
    }

    // Navigation button event listeners
    document.addEventListener("click", function(e) {
      if (e.target.closest("#prevTourBtn") || e.target.closest("#prevTourBtnMobile")) {
        navigateToTour('prev');
      }
      if (e.target.closest("#nextTourBtn") || e.target.closest("#nextTourBtnMobile")) {
        navigateToTour('next');
      }
    });

    // Close modal on escape key, navigate with arrow keys
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        closeTourModal();
      }
      if (e.key === "ArrowLeft") {
        navigateToTour('prev');
      }
      if (e.key === "ArrowRight") {
        navigateToTour('next');
      }
    });
    
    // Share button functionality
    function getShareUrl() {
      return window.location.href;
    }
    
    function getShareText() {
      if (!currentTourData) return '';
      return `${currentTourData.title} - ${currentTourData.price} | Jasmine Tours`;
    }
    
    // Add event listeners for share buttons
    document.addEventListener("click", function(e) {
      const shareBtn = e.target.closest(".share-btn");
      if (!shareBtn || !currentTourData) return;
      
      const url = getShareUrl();
      const text = getShareText();
      const encodedText = encodeURIComponent(text);
      const encodedUrl = encodeURIComponent(url);
      
      if (shareBtn.classList.contains("share-whatsapp")) {
        // WhatsApp share
        const whatsappUrl = `https://wa.me/?text=${encodedText}%20${encodedUrl}`;
        window.open(whatsappUrl, "_blank");
      } else if (shareBtn.classList.contains("share-facebook")) {
        // Facebook share
        const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;
        window.open(facebookUrl, "_blank", "width=600,height=400");
      } else if (shareBtn.classList.contains("share-twitter")) {
        // Twitter/X share
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`;
        window.open(twitterUrl, "_blank", "width=600,height=400");
      } else if (shareBtn.classList.contains("share-instagram")) {
        // Instagram - copy link to clipboard
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(() => {
            // Show a temporary success message
            const originalTitle = shareBtn.getAttribute("title");
            shareBtn.setAttribute("title", "Ссылка скопирована!");
            
            // Create a tooltip-like notification
            const notification = document.createElement("div");
            notification.textContent = "Ссылка скопирована!";
            notification.style.cssText = "position: fixed; bottom: 100px; right: 24px; background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out;";
            document.body.appendChild(notification);
            
            // Remove notification after 2 seconds
            setTimeout(() => {
              notification.style.animation = "slideOut 0.3s ease-in";
              setTimeout(() => {
                document.body.removeChild(notification);
                shareBtn.setAttribute("title", originalTitle);
              }, 300);
            }, 2000);
          }).catch(() => {
            alert("Не удалось скопировать ссылку");
          });
        } else {
          // Fallback for older browsers
          alert("Скопируйте ссылку: " + url);
        }
      }
    });
  });
</script>
