---
import IntlBaseLayout from "@/layouts/IntlBaseLayout.astro";
import { getPageTranslations } from "@/i18n/i18n";
import { defaultLocale, type Locale } from "@/i18n/config";
import { getEntry } from "astro:content";
import Container from "@/components/layout/Container.astro";
import Hero from "@/components/content/Hero.astro";
import TourFilter from "@/components/content/TourFilter.astro";
import Testemonials from "@/components/content/Testemonials.astro";
import ImageGallery from "@/components/ImageGallery.astro";
import CTASection from "@/components/content/CTASection.astro";

const { t } = await getPageTranslations(defaultLocale as Locale, [
  "common",
  "ui",
  "home",
]);

// Load content from CMS
const heroEntry = await getEntry("hero", "hero");
const heroData = heroEntry?.data;

const tourCategoriesEntry = await getEntry("tour-categories", "categories");
const tourCategoriesData = tourCategoriesEntry?.data?.categories || [];

const testimonialsEntry = await getEntry("testimonials", "testimonials");
const testimonialsData = testimonialsEntry?.data?.testimonials || [];

const galleryEntry = await getEntry("gallery", "gallery");
const galleryData = galleryEntry?.data?.images || [];

// Generate Schema.org Review markup for testimonials
const reviewsSchema = testimonialsData.map((testimonial) => ({
  "@context": "https://schema.org",
  "@type": "Review",
  itemReviewed: {
    "@type": "TravelAgency",
    name: "Jasmine Tours",
    url: "https://jasmine-tours.nl",
  },
  author: {
    "@type": "Person",
    name: testimonial.author.name,
  },
  reviewRating: {
    "@type": "Rating",
    ratingValue: testimonial.rating,
    bestRating: 5,
    worstRating: 1,
  },
  reviewBody: testimonial.quote,
}));

// Generate Schema.org TouristTrip markup for tours
const tourSchemas = tourCategoriesData.flatMap((category) =>
  category.tours.map((tour) => {
    // Handle image path - convert ImageMetadata object to string path
    const imagePath =
      typeof tour.image === "string" ? tour.image : tour.image?.src || "";

    return {
      "@context": "https://schema.org",
      "@type": "TouristTrip",
      name: tour.title,
      description: tour.shortDescription || tour.description.substring(0, 200),
      provider: {
        "@type": "TravelAgency",
        name: "Jasmine Tours",
        url: "https://jasmine-tours.nl",
        description:
          "Русскоязычный гид по Амстердаму и Нидерландам - групповые и индивидуальные экскурсии",
        areaServed: [
          "Amsterdam",
          "Netherlands",
          "Volendam",
          "Zaanse Schans",
          "Rotterdam",
          "Den Haag",
        ],
        availableLanguage: ["Russian", "ru"],
      },
      touristType: category.title,
      duration: tour.duration || "Flexible",
      offers: {
        "@type": "Offer",
        price: tour.price || "Contact for pricing",
        priceCurrency: "EUR",
        availability: "https://schema.org/InStock",
        url: "https://jasmine-tours.nl/#tours",
      },
      image: imagePath.startsWith("http")
        ? imagePath
        : `https://jasmine-tours.nl${imagePath}`,
      url: `https://jasmine-tours.nl/#tours`,
    };
  }),
);
---

<IntlBaseLayout
  locale={defaultLocale}
  pageNS={["common", "ui", "home"]}
  seo={{
    title: t(
      "seo.home_title",
      "Экскурсии по Амстердаму | Гид Зара | Туры на Русском по Нидерландам",
    ),
    description: t(
      "seo.home_description",
      "Экскурсии по Амстердаму на русском с гидом Зарой. Прогулки по каналам, велотуры, индивидуальные и групповые туры. Бронируйте через WhatsApp!",
    ),
    openGraph: {
      basic: {
        title:
          "Экскурсии по Амстердаму на Русском | Гид Зара | Групповые и Индивидуальные Туры",
        type: "website",
        image: "https://jasmine-tours.nl/images/og-image.jpg",
        url: "https://jasmine-tours.nl",
      },
      optional: {
        description:
          "Экскурсии по Амстердаму и Нидерландам с русскоязычным гидом Зарой. Индивидуальные и групповые туры на русском: прогулки по каналам, велотуры, экскурсии в Воленд ам, Заансе Сханс.",
        siteName: "Jasmine Tours",
        locale: "ru_RU",
      },
    },
    twitter: {
      card: "summary_large_image",
      title: "Экскурсии по Амстердаму на Русском | Гид Зара",
      description:
        "Индивидуальные и групповые туры по Амстердаму и Нидерландам с русскоязычным гидом. Прогулки по каналам, велотуры, экскурсии.",
    },
    extend: {
      meta: [
        {
          name: "keywords",
          content:
            "экскурсии по амстердаму, русскоязычный гид амстердам, экскурсии на русском амстердам, туры в амстердаме, гид в нидерландах, прогулки по каналам амстердама, велотуры амстердам, групповые туры нидерланды, индивидуальные экскурсии амстердам, экскурсии воленд ам, туры заансе сханс, гид зара амстердам",
        },
        {
          name: "author",
          content: "Zara - Русскоязычный гид в Амстердаме",
        },
        {
          name: "robots",
          content: "index, follow",
        },
        {
          property: "og:locale:alternate",
          content: "en_US",
        },
      ],
    },
  }}
>
  <!-- Schema.org Structured Data for Tours and Reviews -->
  <Fragment slot="head">
    {
      tourSchemas.map((tourSchema) => (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(tourSchema)}
        />
      ))
    }
    {
      reviewsSchema.map((review) => (
        <script type="application/ld+json" set:html={JSON.stringify(review)} />
      ))
    }
  </Fragment>

  <div class="relative">
    {
      heroData && (
        <Hero
          variant="split"
          subtitle={heroData.subtitle}
          title={heroData.title}
          description={heroData.description}
          images={heroData.images}
        />
      )
    }
  </div>

  <section id="tours">
    <TourFilter
      t={t}
      tourCategories={tourCategoriesData}
      locale={defaultLocale}
    />
  </section>

  <section id="testimonials">
    <Testemonials t={t} testimonials={testimonialsData} />
  </section>

  <section class="py-20 bg-muted/30">
    <Container size="xl" padding="lg">
      <div class="text-center mb-16 animate-fade-up">
        <h2 class="text-3xl md:text-4xl font-bold text-foreground mb-6">
          {t("gallery.section_title", "Мгновения из наших туров")}
        </h2>
        <p class="text-xl text-muted-foreground max-w-2xl mx-auto">
          {
            t(
              "gallery.section_description",
              "Лучшие кадры, наполненные атмосферой Амстердама и путешествий по Нидерландам",
            )
          }
        </p>
      </div>

      <div class="animate-fade-up animate-delay-1">
        <ImageGallery
          images={galleryData}
          columns={3}
          gap={24}
          showThumbnails={true}
          showCaption={true}
          showFullscreen={true}
          lazy={true}
          aspectRatio="landscape"
          className="mb-8"
        />
      </div>
    </Container>
  </section>

  <CTASection t={t} locale={defaultLocale} backgroundColor="primary" />
</IntlBaseLayout>
